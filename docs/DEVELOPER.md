# 开发者指南（v2.2.0）

本项目自 v2.2.0 起，开始进行“可维护性优先”的架构重构。目标是令核心逻辑高内聚、低耦合，便于长期演进与数值平衡。本文档向开发者说明当前结构、约定与扩展方法。

## 架构概览

- 入口与应用状态
  - `index.html`：应用入口页面。以 ES Module 方式加载脚本。
  - `main.js`：现有主要逻辑所在的单文件，逐步向模块迁移中。维护全局 `gameState`、初始化与 UI 桥接。
- 核心模块（新增）
  - `src/core/utils.js`：通用小工具函数（`clamp`、`randomInt`、`randomChoice`、`timestamp`）。
  - `src/core/constants.js`：跨模块共享常量（品质序、难度等级集合、分段系数等）。
- 战斗子系统（新增）
  - `src/systems/battleEngine.js`：战斗引擎（进行中）。当前已承载“命中后挂载减益”的统一入口。后续将逐步迁移普攻、技能、回合推进等。

后续将把“商店”“事件”“数值公式”“数据定义”分离到各自模块，形成如下分层：

- `src/data/*`：纯数据（职业、药水、藏品、事件、敌人池），不得含业务逻辑。
- `src/core/*`：纯规则（通用常量、通用函数、数值公式），无 DOM、副作用。
- `src/systems/*`：业务模块（商店、战斗、事件、掉落等），输入输出均为 `state` 与纯数据对象，不直接操作 DOM。
- `src/ui/*`：渲染与事件绑定，唯一负责 DOM。

## 代码风格与约定

- 函数签名优先使用“显式依赖”而非读写全局：
  - 例如 `openShop(state)` 优于直接使用 `gameState`，以便测试与复用。
- 纯函数优先：将数值计算、掉落概率等放在不带副作用的函数中，便于单测与回归。
- 命名约定：
  - 纯数据常量使用全大写（如 `RELICS`）。
  - 互操作函数使用动宾结构（如 `applyMagicDamage`、`grantRelic`）。
  - 模块导出的类使用名词性复合（如 `BattleEngine`、`ShopSystem`）。
- 日志：统一通过 `pushLog` 或 `pushBattleLog`，确保 UI 与历史一致。

## 扩展与修改示例

- 新增一个“命中后”类遗物：
  1) 在战斗引擎的 `applyOnHitDebuffs` 内添加新分支（或将其抽象为插件表），仅修改传入敌人对象与日志。
  2) 在遗物效果表接入一个明确的键位（如 `freezeOnHit`），在 `updatePlayerStats` 把该键位映射到 `player.stats.*`。

- 新增一种价格规则：
  1) 在“商店系统”内新增 `pricePolicy` 接口；
  2) 在 `computeShopPrice` 内调用该接口，保持旧逻辑在不存在策略时正常运行。

## 迁移路线图（建议）

1. 把数值公式（`pwLinear`、难度倍率、物理/法术结算）迁移到 `src/core/balance.js`。
2. 把职业、药水、藏品、事件移入 `src/data/*`，`main.js` 仅导入。
3. 拆分“商店系统”为 `src/systems/shop.js` 的 `ShopSystem` 类，`main.js` 调用其方法。
4. 拆出 `src/ui/render.js`，把渲染逻辑与系统逻辑彻底解耦。
5. 最后将 `main.js` 精简为：应用启动、全局状态管理、模块装配、顶层事件绑定。

## 测试与回归

- 建议为 `src/core` 与 `src/systems` 层的纯函数添加最小化的断言脚本（可独立于 DOM 运行）。
- 战斗与商店关键路径的行为，需要以“日志断言”与“状态快照”双通道进行回归核对。

如需进一步重构帮助或编写首批单元测试脚本，请在 Issue 中标记模块名称与用例场景。我们会按模块先后顺序拆分与迁移，确保任意时刻可运行、可回滚。
